#!/bin/bash
# commit-msg hook: Add [skip ci] when no code changes

COMMIT_MSG_FILE="$1"

if git rev-parse HEAD >/dev/null 2>&1; then
    STAGED_FILES=$(git diff --cached --name-only)
    [ -z "$STAGED_FILES" ] && exit 0
else
    STAGED_FILES=$(git diff --cached --name-only)
fi

# Code paths (library packages)
CODE_PATHS="^[a-z]+/|^go\.mod$|^go\.sum$"

echo "$STAGED_FILES" | grep -qE "$CODE_PATHS" && exit 0

FIRST_LINE=$(head -n 1 "$COMMIT_MSG_FILE")
if [[ "$FIRST_LINE" != *"[skip ci]"* ]] && [[ "$FIRST_LINE" != *"[ci skip]"* ]]; then
    sed "1s/$/ [skip ci]/" "$COMMIT_MSG_FILE" > "$COMMIT_MSG_FILE.tmp"
    mv "$COMMIT_MSG_FILE.tmp" "$COMMIT_MSG_FILE"
fi

exit 0
